# 抖音自动续火花插件

> 自动给抖音指定联系人发送私信，保持互动（续火花）

## 📖 项目概述

本插件是一个基于用户脚本的抖音自动续火花工具，采用增强版错误报告系统，支持智能私信按钮定位、多策略联系人查找和全面的调试功能。

### 主要功能
- 🔥 **自动续火花**: 定时向指定联系人发送私信保持互动
- 🧠 **智能定位**: 多种策略查找私信按钮和联系人
- 📊 **完整调试**: 可视化错误报告和执行日志
- ⚙️ **灵活配置**: 支持手动和自动执行模式
- 🔍 **实时监控**: 详细的执行过程追踪

## 🚀 快速开始

### 安装使用

#### 方法1: 直接使用改进版脚本

1. **安装Tampermonkey插件**
   - Chrome: [Chrome Web Store](https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo)
   - Firefox: [Firefox Add-ons](https://addons.mozilla.org/firefox/addon/tampermonkey/)

2. **导入脚本**
   - 复制 `project.js` 中的全部内容
   - 在Tampermonkey中创建新脚本
   - 粘贴并保存

3. **配置参数**
   ```javascript
   // 修改联系人列表
   const CONTACTS = ["你的联系人1", "你的联系人2"];
   
   // 修改消息内容
   const MESSAGE = "你想发送的消息内容";
   
   // 修改发送间隔（可选）
   const INTERVAL = 1000 * 60 * 60 * 24; // 24小时
   ```

#### 方法2: 测试脚本功能

1. **下载测试页面**
   - 保存 `test_improvements.html` 到本地
   - 用浏览器打开

2. **测试各项功能**
   - 点击测试按钮验证功能
   - 查看测试结果

### 配置说明

#### 联系人配置
```javascript
const CONTACTS = ["HH", "联系人2"];
```
⚠️ **注意**: 联系人昵称必须与抖音私信列表中显示的完全一致

#### 消息内容配置
```javascript
const MESSAGE = "[自动程序发送]续火花咯！";
```

#### 定时设置
```javascript
const ENABLE_AUTO = true;  // 启用自动执行
const SCHEDULE_TIME = "09:00";  // 每天9点执行
```

### 使用步骤

1. **打开抖音网站** - https://www.douyin.com
2. **登录账号** - 确保已登录
3. **启动脚本** - 点击右上角的"手动续火花"按钮
4. **查看日志** - 点击"🐛 查看日志"按钮查看执行情况

## 🔧 技术特性

### 增强版错误报告功能

#### 1. 多级日志系统
- **DEBUG**: 调试信息，详细的执行步骤
- **INFO**: 一般信息，执行状态和进度
- **WARN**: 警告信息，非致命性问题
- **ERROR**: 错误信息，执行失败的详细原因

#### 2. 可视化错误面板
- 右上角新增"🐛 查看日志"按钮
- 实时显示最近20条日志记录
- 支持清空日志历史
- 错误按级别用不同颜色区分

#### 3. 智能错误通知
- 执行失败时自动弹出错误通知
- 显示具体的失败原因和建议
- 执行完成后显示汇总统计
- 点击通知可查看详细日志

#### 4. 配置验证
- 启动时自动检查配置参数
- 验证联系人列表、消息内容等设置
- 配置错误时给出具体修复建议

#### 5. 详细的执行追踪
- 每个步骤都有详细的日志记录
- 失败时记录具体的DOM元素查找过程
- 记录重试次数和失败原因
- 支持执行结果统计和分析

### 增强的私信按钮查找算法

实现了6种查找策略，其中包括新增的绝对位置定位方法：

#### 策略0: 绝对位置定位（新增）
基于页面布局特征和元素位置的智能定位：
- **右上角区域定位**: 基于典型抖音布局，私信按钮通常在右上角
- **固定定位元素查找**: 分析页面顶部的固定定位导航栏
- **Z-index层级分析**: 查找高层级的界面元素
- **网格搜索**: 将页面分成优先级网格进行搜索
- **模式分析**: 基于常见CSS类名模式的位置分析

```javascript
// 绝对位置定位示例
const rightTopRegion = {
    left: viewportWidth * 0.7,  // 右侧30%区域
    top: 0,
    right: viewportWidth,
    bottom: viewportHeight * 0.2 // 顶部20%区域
};
```

#### 策略1: 多文本变体匹配
```javascript
const textVariations = ['私信', '消息', 'Message', 'PM', 'DM'];
```

#### 策略2: CSS类名和数据属性匹配
```javascript
const cssSelectors = [
    '[class*="message"]', '[class*="chat"]', '[class*="im-"]',
    '[data-e2e*="message"]', 'a[href*="/message"]'
];
```

#### 策略3: 位置和上下文分析
- 在导航区域中查找
- 基于元素在页面中的位置判断

#### 策略4: SVG图标检测
- 查找消息相关的SVG图标
- 定位图标的可点击父元素

#### 策略5: 智能模糊匹配
- 综合所有可点击元素进行智能匹配
- 排除明显不相关的元素

### 改进的联系人查找

#### 绝对位置定位（新增）
```javascript
function findContactByAbsolutePosition(container, contact)
```
- **垂直列表分析**: 基于典型聊天列表的垂直排列特征
- **位置网格搜索**: 使用坐标网格系统查找联系人
- **布局模式识别**: 分析相似高度元素识别列表项

#### 多容器搜索策略
```javascript
function findContactInContainer(container, contact)
function findContactGlobally(contact)
```

#### 智能匹配机制
- 检查文本内容、title、alt、aria-label等多个属性
- 模糊匹配支持部分匹配

#### 可点击元素检测
```javascript
function getClickableElement(element)
```

### 强化的输入框检测

#### 绝对位置定位（新增）
```javascript
function findInputBoxByAbsolutePosition()
```
- **底部区域扫描**: 聊天输入框通常位于页面底部
- **固定定位查找**: 分析固定或粘性定位的输入容器
- **Z-index分析**: 查找高层级浮动输入区域
- **垂直位置扫描**: 找到页面最底部的有效输入框
- **中心底部定位**: 专门搜索页面中心底部区域

#### 输入框验证
```javascript
function isValidInputBox(element)
```
- 检查可见性
- 验证输入类型
- 检查大小和可编辑性

#### 多策略查找
- 专门的输入框选择器
- 聊天区域内查找
- 位置分析（底部输入框）

### 增强的消息发送

#### 多种发送方法
1. **发送按钮点击**: 智能识别发送按钮
2. **键盘发送**: 多种Enter键组合
3. **表单提交**: 备选提交方式

#### 绝对位置定位的优势

相比传统的选择器和文本匹配方法，绝对位置定位具有以下优势：

1. **布局无关性**: 不依赖特定的CSS类名或HTML结构
2. **视觉定位**: 基于用户实际看到的元素位置进行定位
3. **适应性强**: 能够适应页面结构的变化和更新
4. **效率更高**: 直接基于坐标和视窗位置进行搜索
5. **覆盖面广**: 能够找到传统方法遗漏的元素

#### 位置定位原理

```javascript
// 示例：查找右上角私信按钮
const rightTopRegion = {
    left: viewportWidth * 0.7,   // 从70%宽度开始
    top: 0,                      // 从顶部开始
    right: viewportWidth,        // 到页面右边
    bottom: viewportHeight * 0.2 // 到20%高度处
};
```

这种方法模拟了人眼查找元素的过程，更加符合用户的使用习惯。

### 改进的事件模拟
```javascript
// 触发多种事件确保检测到输入
const events = ['input', 'keyup', 'change', 'paste'];
events.forEach(eventType => {
    inputBox.dispatchEvent(new Event(eventType, { bubbles: true }));
});
```

## 🐛 故障排除

### 常见问题

#### 1. "未找到私信按钮"
**原因**: 页面未完全加载或页面结构发生变化
**解决方案:**
- ✅ 确认页面已完全加载
- ✅ 确认已登录抖音账号
- ✅ 刷新页面重试
- ✅ 检查浏览器控制台错误信息

#### 2. "未找到联系人"
**原因**: 联系人昵称配置错误或联系人不在私信列表中
**解决方案:**
- ✅ 检查联系人昵称是否正确
- ✅ 确认联系人在私信列表中
- ✅ 确认已成功进入私信页面

#### 3. "未找到消息输入框"
**原因**: 没有成功进入聊天界面
**解决方案:**
- ✅ 确认已成功选择联系人
- ✅ 等待聊天界面完全加载
- ✅ 检查是否有权限发送消息

#### 4. "配置验证失败"
**原因**: 脚本配置参数不正确
**解决方案:**
- ✅ 检查CONTACTS是否为有效数组
- ✅ 检查MESSAGE是否为有效字符串
- ✅ 检查时间格式是否为HH:MM

### 高级调试

#### 1. 使用网站结构分析工具
```javascript
// 在抖音网站控制台中运行
// 复制 analyze_douyin_structure.js 内容并执行
```

#### 2. 启用详细日志
```javascript
// 在脚本配置中添加
errorReporter.logLevel = 'DEBUG';
```

#### 3. 手动测试选择器
```javascript
// 在控制台测试
douyinAnalyzer.highlightElements('你的选择器');
```

### 执行结果统计

执行完成后会显示详细统计：
- **总计**: 处理的联系人总数
- **成功**: 成功发送消息的数量
- **失败**: 发送失败的数量
- **失败详情**: 具体哪些联系人失败及原因

## ⚙️ 高级配置

### 自定义等待时间
```javascript
const WAIT = 3000; // 增加到3秒（如果网络较慢）
```

### 自定义重试次数
修改各函数中的循环次数：
```javascript
for (let i = 0; i < 20; i++) { // 增加到20次
```

### 添加自定义选择器
在 `findPrivateMessageButton` 函数中添加：
```javascript
const customSelectors = [
    '.your-custom-selector',
    '[data-your-attribute]'
];
```

### 调试模式

如需更详细的调试信息：
1. 打开浏览器开发者工具(F12)
2. 查看Console标签页
3. 所有日志都会在控制台输出，包含完整的错误堆栈

### 配置建议

为了获得最佳的错误报告体验：

1. **设置合理的等待时间**:
   ```javascript
   const WAIT = 2000; // 建议不少于2秒
   ```

2. **准确配置联系人昵称**:
   ```javascript
   const CONTACTS = ["张三", "李四"]; // 使用完全匹配的昵称
   ```

3. **启用调试模式**(可选):
   ```javascript
   // 在errorReporter初始化后添加
   errorReporter.logLevel = 'DEBUG';
   ```

## 📱 浏览器兼容性

- ✅ Chrome (推荐)
- ✅ Firefox
- ✅ Edge
- ⚠️ Safari (可能需要额外配置)

## 🔒 隐私安全

- ✅ 脚本仅在抖音网站运行
- ✅ 不收集任何个人信息
- ✅ 不向外部服务器发送数据
- ✅ 开源代码，可自行审查

## 📞 技术支持

如果遇到问题：

1. **查看错误日志** - 使用脚本内置的日志功能
2. **运行分析工具** - 使用提供的网站结构分析脚本
3. **检查配置** - 确认联系人昵称等配置正确
4. **更新脚本** - 确保使用最新版本的增强脚本

## 🎯 成功指标

脚本正常工作时，你应该看到：
- ✅ 找到私信按钮并成功点击
- ✅ 成功进入私信界面
- ✅ 找到并选择目标联系人
- ✅ 成功发送消息
- ✅ 显示执行成功通知

## 📁 项目文件说明

### 核心文件
- `project.js` - 主要的脚本文件，包含所有功能逻辑
- `test_improvements.html` - 功能测试页面，用于验证脚本功能
- `analyze_douyin_structure.js` - 网站结构分析工具，帮助调试选择器

### 技术改进点

1. **容错性**: 多策略备选机制
2. **可维护性**: 模块化函数设计
3. **可调试性**: 详细日志和错误信息
4. **兼容性**: 支持不同的页面结构
5. **性能**: 渐进式查找，避免不必要的等待

## 🚀 版本更新

### v2.0 新增功能
- ✅ 完整的错误报告系统
- ✅ 可视化日志面板
- ✅ 智能错误通知
- ✅ 配置验证机制
- ✅ 执行结果统计
- ✅ 详细的调试信息
- ✅ 错误恢复机制
- ✅ 用户友好的错误提示

---

💡 **小贴士**: 首次使用建议先进行手动测试，确认所有功能正常后再启用自动执行。

通过这些改进，脚本能够更好地适应抖音网站的结构变化，提供更稳定可靠的自动化功能。
